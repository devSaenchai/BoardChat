<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoardChat - Live Sketch</title>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #121212; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #toolbar {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.8);
            padding: 8px 15px; border-radius: 25px; backdrop-filter: blur(15px); z-index: 100;
            border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        button { padding: 10px 18px; border: none; border-radius: 15px; background: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        button.active { background: #007AFF; color: white; }
        #logo { color: white; font-weight: 800; margin-right: 12px; align-self: center; font-size: 14px; letter-spacing: -0.5px; }
        canvas { display: block; background: #ffffff; touch-action: none; }
    </style>
</head>
<body>

    <div id="toolbar">
        <div id="logo">BOARDCHAT</div>
        <button id="drawBtn" class="active">Pen</button>
        <button id="eraseBtn">Eraser</button>
        <button onclick="clearBoard()" style="background: #ff3b30; color: white;">Clear</button>
    </div>

    <canvas id="sketchBoard"></canvas>

    <script>
        // 1. SUPABASE INITIALIZATION
        // Replace 'YOUR_SUPABASE_URL' and 'YOUR_ANON_KEY' with your actual values
        const SB_URL = 'YOUR_SUPABASE_URL';
        const SB_KEY = 'YOUR_ANON_KEY';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        // Join the global channel
        const channel = supabaseClient.channel('boardchat-sync', {
            config: { broadcast: { self: false } }
        });

        const canvas = document.getElementById('sketchBoard');
        const ctx = canvas.getContext('2d');
        let isDrawing = false, mode = 'draw';

        // 2. CANVAS SETUP
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }
        window.addEventListener('resize', resize);
        resize();

        // 3. UI CONTROLS
        document.getElementById('drawBtn').onclick = () => { mode = 'draw'; updateUI(); };
        document.getElementById('eraseBtn').onclick = () => { mode = 'erase'; updateUI(); };

        function updateUI() {
            document.getElementById('drawBtn').className = mode === 'draw' ? 'active' : '';
            document.getElementById('eraseBtn').className = mode === 'erase' ? 'active' : '';
        }

        // 4. DRAWING LOGIC
        function getPos(e) {
            const t = e.touches ? e.touches[0] : e;
            return { x: t.clientX / canvas.width, y: t.clientY / canvas.height };
        }

        function drawLine(x, y, m, start) {
            const rx = x * canvas.width, ry = y * canvas.height;
            ctx.lineWidth = m === 'draw' ? 4 : 40;
            ctx.globalCompositeOperation = m === 'draw' ? 'source-over' : 'destination-out';
            ctx.strokeStyle = '#000';

            if (start) ctx.beginPath();
            ctx.lineTo(rx, ry);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(rx, ry);
        }

        const handleStart = (e) => {
            isDrawing = true;
            const p = getPos(e);
            drawLine(p.x, p.y, mode, true);
            sync(p.x, p.y, mode, true);
        };

        const handleMove = (e) => {
            if(!isDrawing) return;
            const p = getPos(e);
            drawLine(p.x, p.y, mode, false);
            sync(p.x, p.y, mode, false);
        };

        const handleEnd = () => { isDrawing = false; ctx.beginPath(); };

        // 5. REALTIME SYNC
        function sync(x, y, m, s) {
            channel.send({
                type: 'broadcast',
                event: 'stroke',
                payload: { x, y, m, s }
            });
        }

        channel.on('broadcast', { event: 'stroke' }, ({ payload }) => {
            drawLine(payload.x, payload.y, payload.m, payload.s);
        }).on('broadcast', { event: 'clear' }, () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }).subscribe();

        function clearBoard() {
            if(confirm("Clear board for everyone?")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                channel.send({ type: 'broadcast', event: 'clear' });
            }
        }

        // 6. EVENT LISTENERS (Mobile + Desktop)
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
    </script>
</body>
</html>
