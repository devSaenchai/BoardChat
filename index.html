<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoardChat - Live Sketch</title>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        /* Force app to stay on one screen with no scrolling/zooming */
        html, body { 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            margin: 0; 
            background: #000;
        }

        #toolbar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.8);
            padding: 8px; border-radius: 50px; z-index: 999;
            border: 1px solid rgba(255,255,255,0.2);
        }

        button { padding: 12px 20px; border: none; border-radius: 25px; background: #fff; font-weight: bold; cursor: pointer; }
        button.active { background: #007AFF; color: white; }

        canvas { 
            display: block; 
            background: #fff; 
            touch-action: none; /* Disable all browser gestures */
            z-index: 1;
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <button id="drawBtn" class="active">Pen</button>
        <button id="eraseBtn">Eraser</button>
        <button onclick="clearBoard()" style="background: #ff3b30; color: white;">Clear</button>
    </div>

    <canvas id="sketchBoard"></canvas>

    <script>
        // --- 1. SUPABASE CONNECTION ---
        const SB_URL = 'https://sujawkmwxhdqoaadyewh.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1amF3a213eGhkcW9hYWR5ZXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTkxMTUsImV4cCI6MjA4NTkzNTExNX0.Yy2D63Vshq5PgH-IPOADRW-ShWcPaXZ4G-6VjOT7VIg';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const channel = supabaseClient.channel('boardchat');

        // --- 2. CANVAS SETUP ---
        const canvas = document.getElementById('sketchBoard');
        const ctx = canvas.getContext('2d');
        let isDrawing = false, mode = 'draw';

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 5;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 3. TOUCH LOGIC ---
        function getTouchPos(e) {
            const touch = e.touches ? e.touches : e;
            const rect = canvas.getBoundingClientRect();
            return {
                x: (touch.clientX - rect.left) / canvas.width,
                y: (touch.clientY - rect.top) / canvas.height
            };
        }

        const handleStart = (e) => {
            e.preventDefault(); // STOP MOBILE SCROLL
            isDrawing = true;
            const p = getTouchPos(e);
            ctx.beginPath();
            sync(p.x, p.y, mode, true);
        };

        const handleMove = (e) => {
            if(!isDrawing) return;
            e.preventDefault(); // STOP MOBILE SCROLL
            const p = getTouchPos(e);
            
            ctx.lineWidth = mode === 'draw' ? 5 : 40;
            ctx.globalCompositeOperation = mode === 'draw' ? 'source-over' : 'destination-out';
            ctx.strokeStyle = '#000';
            ctx.lineTo(p.x * canvas.width, p.y * canvas.height);
            ctx.stroke();
            sync(p.x, p.y, mode, false);
        };

        const handleEnd = () => { isDrawing = false; };

        // --- 4. SYNC ---
        function sync(x, y, m, s) {
            channel.send({ type: 'broadcast', event: 'stroke', payload: { x, y, m, s } });
        }

        channel.on('broadcast', { event: 'stroke' }, ({ payload }) => {
            const rx = payload.x * canvas.width;
            const ry = payload.y * canvas.height;
            ctx.lineWidth = payload.m === 'draw' ? 5 : 40;
            ctx.globalCompositeOperation = payload.m === 'draw' ? 'source-over' : 'destination-out';
            if (payload.s) ctx.beginPath();
            ctx.lineTo(rx, ry);
            ctx.stroke();
        }).on('broadcast', { event: 'clear' }, () => ctx.clearRect(0,0,canvas.width,canvas.height)).subscribe();

        function clearBoard() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            channel.send({ type: 'broadcast', event: 'clear' });
        }

        // --- 5. LISTENERS ---
        document.getElementById('drawBtn').onclick = () => { mode = 'draw'; document.getElementById('drawBtn').className='active'; document.getElementById('eraseBtn').className=''; };
        document.getElementById('eraseBtn').onclick = () => { mode = 'erase'; document.getElementById('eraseBtn').className='active'; document.getElementById('drawBtn').className=''; };

        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
    </script>
</body>
</html>
