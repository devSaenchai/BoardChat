<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoardChat - Live Sketch</title>
    <script src="https://cdn.jsdelivr.net"></script>
    <style>
        /* Force app to stay on one screen with no scrolling/zooming */
        html, body { 
            position: fixed; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; 
            margin: 0; 
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #toolbar {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.8);
            padding: 8px 20px; border-radius: 50px; z-index: 999;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        button { padding: 12px 20px; border: none; border-radius: 25px; background: #fff; font-weight: bold; cursor: pointer; }
        button.active { background: #007AFF; color: white; }

        canvas { 
            display: block; 
            background: #fff; 
            touch-action: none; /* CRITICAL FIX: Disable all browser gestures */
            z-index: 1;
        }
    </style>
</head>
<body>

    <div id="toolbar">
        <button id="drawBtn" class="active">Pen</button>
        <button id="eraseBtn">Eraser</button>
        <button onclick="clearBoard()" style="background: #ff3b30; color: white;">Clear</button>
    </div>

    <canvas id="sketchBoard"></canvas>

    <script>
        // --- 1. SUPABASE CONNECTION ---
        const SB_URL = 'https://sujawkmwxhdqoaadyewh.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1amF3a213eGhkcW9hYWR5ZXdoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNTkxMTUsImV4cCI6MjA4NTkzNTExNX0.Yy2D63Vshq5PgH-IPOADRW-ShWcPaXZ4G-6VjOT7VIg';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        // Using a dedicated channel name for robust sync
        const channel = supabaseClient.channel('boardchat-live-channel');

        // --- 2. CANVAS SETUP ---
        const canvas = document.getElementById('sketchBoard');
        const ctx = canvas.getContext('2d');
        let isDrawing = false, mode = 'draw';

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 5;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- 3. UI CONTROLS ---
        document.getElementById('drawBtn').onclick = () => { mode = 'draw'; updateUI(); };
        document.getElementById('eraseBtn').onclick = () => { mode = 'erase'; updateUI(); };

        function updateUI() {
            document.getElementById('drawBtn').className = mode === 'draw' ? 'active' : '';
            document.getElementById('eraseBtn').className = mode === 'erase' ? 'active' : '';
        }

        // --- 4. DRAWING LOGIC (Mobile Optimized) ---
        function getPos(e) {
            const t = e.touches ? e.touches[0] : e; // Use the first touch if multiple
            const rect = canvas.getBoundingClientRect();
            return {
                x: (t.clientX - rect.left) / canvas.width,
                y: (t.clientY - rect.top) / canvas.height
            };
        }

        function drawLine(x, y, m, start) {
            const rx = x * canvas.width, ry = y * canvas.height;
            ctx.lineWidth = m === 'draw' ? 5 : 40;
            ctx.globalCompositeOperation = m === 'draw' ? 'source-over' : 'destination-out';
            ctx.strokeStyle = '#000';

            if (start) ctx.beginPath();
            ctx.lineTo(rx, ry);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(rx, ry);
        }

        const handleStart = (e) => {
            e.preventDefault(); // Stop mobile scrolling
            isDrawing = true;
            const p = getPos(e);
            ctx.beginPath(); // Ensure a fresh line starts here
            sync(p.x, p.y, mode, true);
        };

        const handleMove = (e) => {
            if(!isDrawing) return;
            e.preventDefault(); // Stop mobile scrolling
            const p = getPos(e);
            
            ctx.lineWidth = mode === 'draw' ? 5 : 40;
            ctx.globalCompositeOperation = mode === 'draw' ? 'source-over' : 'destination-out';
            ctx.strokeStyle = '#000';
            ctx.lineTo(p.x * canvas.width, p.y * canvas.height);
            ctx.stroke();
            sync(p.x, p.y, mode, false);
        };

        const handleEnd = () => { isDrawing = false; ctx.beginPath(); };

        // --- 5. REALTIME SYNC ---
        function sync(x, y, m, s) {
            channel.send({ type: 'broadcast', event: 'stroke', payload: { x, y, m, s } });
        }

        channel.on('broadcast', { event: 'stroke' }, ({ payload }) => {
            drawLine(payload.x, payload.y, payload.m, payload.s);
        }).on('broadcast', { event: 'clear' }, () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }).subscribe();

        function clearBoard() {
            if(confirm("Clear board for everyone?")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                channel.send({ type: 'broadcast', event: 'clear' });
            }
        }

        // --- 6. EVENT LISTENERS ---
        // {passive: false} is crucial for mobile drawing performance
        canvas.addEventListener('touchstart', handleStart, {passive: false});
        canvas.addEventListener('touchmove', handleMove, {passive: false});
        canvas.addEventListener('touchend', handleEnd);
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('mouseup', handleEnd);
    </script>
</body>
</html>
